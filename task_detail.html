
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Available Tasks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* ---------- Same CSS as before ---------- */
        :root {
            --primary: #4776E6;
            --primary-gradient: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%);
            --secondary: #FF8C42;
            --text-dark: #2D3748;
            --text-light: #718096;
            --white: #ffffff;
            --off-white: #F7FAFC;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(71, 118, 230, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: var(--off-white); color: var(--text-dark); line-height: 1.6; }
        h1,h2,h3,h4 { font-family: 'Montserrat', sans-serif; font-weight: 700; line-height: 1.3; }

        /* Navbar & Buttons */
        .navbar { background: var(--white); padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 100; }
        .logo { color: var(--text-dark); font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.5rem; text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .logo span { background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-icon { color: var(--primary); font-size: 1.5rem; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-link { color: var(--text-dark); text-decoration: none; font-weight: 500; transition: color 0.3s; font-size: 0.95rem; }
        .nav-link:hover { color: var(--primary); }
        .nav-link.active { color: var(--primary); font-weight: 600; }
        .nav-link.highlight { background: var(--primary-gradient); color: var(--white); padding: 8px 20px; border-radius: 50px; font-weight: 500; }
        .user-menu { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem; }

        .container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 30px 20px; }
        .breadcrumb { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 0.9rem; }
        .breadcrumb a { color: var(--text-light); text-decoration: none; transition: color 0.3s; }
        .breadcrumb a:hover { color: var(--primary); }
        .breadcrumb .separator { color: var(--text-light); }
        .breadcrumb .current { color: var(--text-dark); font-weight: 500; }

        /* Task Card */
        .task-detail-card { background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 30px; }
        .task-detail-header { padding: 25px 30px; background: var(--primary-gradient); color: var(--white); display: flex; justify-content: space-between; align-items: center; }
        .task-detail-title { font-size: 1.5rem; margin: 0; }
        .task-status { padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background-color: rgba(255,255,255,0.2); }

        .task-detail-content { padding: 30px; }
        .task-detail-section { margin-bottom: 25px; }
        .section-title { font-size: 1.1rem; margin-bottom: 15px; color: var(--text-dark); display: flex; align-items: center; gap: 10px; }
        .section-title i { color: var(--primary); }
        .detail-row { display: flex; margin-bottom: 12px; }
        .detail-label { min-width: 150px; font-weight: 500; color: var(--text-light); }
        .detail-value { color: var(--text-dark); flex: 1; }
        .task-description { background-color: var(--off-white); padding: 20px; border-radius: 8px; margin-bottom: 10px; }
        .map-container { height: 250px; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .special-instructions { background-color: rgba(71, 118, 230, 0.05); padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary); }
        .action-buttons { display: flex; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 50px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary-gradient); color: var(--white); }
        .btn-secondary { background: var(--white); color: var(--text-dark); border: 1px solid rgba(0,0,0,0.1); }
        .task-requester { display: flex; align-items: center; gap: 15px; padding: 20px; background-color: var(--off-white); border-radius: 8px; }
        .requester-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.1rem; }
        .requester-info { flex: 1; }
        .requester-name { font-weight: 600; margin-bottom: 3px; }
        .requester-rating { display: flex; align-items: center; gap: 5px; color: var(--secondary); font-size: 0.9rem; }
        .requester-meta { font-size: 0.85rem; color: var(--text-light); }
        .section-divider { height: 1px; background-color: rgba(0,0,0,0.05); margin: 30px 0; }
        .related-tasks { margin-top: 40px; }
        .related-tasks-title { font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .related-tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .related-task-card { background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 15px; text-decoration: none; color: inherit; }
        .related-task-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(71, 118, 230, 0.15); }
        .related-task-title { font-size: 1rem; margin-bottom: 10px; }
        .related-task-meta { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-light); }
        .task-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>
<nav class="navbar">
    <a href="/" class="logo"><i class="fas fa-route logo-icon"></i> Swa<span>Drive</span></a>
    <div class="nav-links">
        <a href="Home.html" class="nav-link">Home</a>
        <a href="task_detail.html" class="nav-link active">Find Tasks</a>
        <a href="notifications.html" class="nav-link">
  <i class="fas fa-bell"></i> Notifications
</a>

        <a href="d1.html" class="nav-link">List a Need</a>
        <a href="Home.html" class="nav-link">How It Works</a>
        <a href="tasks.html" class="nav-link highlight"><i class="fas fa-plus"></i> List Task</a>
    </div>
    <div class="user-menu"><div class="user-avatar">KS</div><i class="fas fa-chevron-down" style="font-size:0.7rem;color:var(--text-light)"></i></div>
</nav>

<div class="container">
    <div class="breadcrumb">
        <a href="Home.html">Home</a><span class="separator"><i class="fas fa-chevron-right"></i></span>
        <a href="tasks.html">Available Tasks</a><span class="separator"><i class="fas fa-chevron-right"></i></span>
        <span class="current">All Tasks</span>
    </div>

    <div id="task-list"></div>
</div>

<script>
const BACKEND_URL = "https://swadrive-backend-2bou.onrender.com";
const taskList = document.getElementById("task-list");

// ---------- COMMON ----------
function formatDateTime(str) {
  if (!str) return '';
  const d = new Date(str);
  if (isNaN(d)) return str;
  return d.toLocaleString("en-IN");
}

// ========== ACTIVE / COMPLETED TOGGLE ==========
// by default active tasks dikha rahe hain
let currentTab = "active";   // "active" | "completed"

/* ========== LOAD TASKS (ACTIVE YA COMPLETED) ========== */
async function loadTasks() {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("❌ Please login first");
    window.location.href = "index.html";   // tumhari login page ka naam
    return;
  }

  // endpoint choose karo tab ke hisaab se
  const endpoint =
    currentTab === "completed"
      ? "/api/my-completed-tasks"
      : "/api/my-tasks";

  try {
    const res = await fetch(`${BACKEND_URL}${endpoint}`, {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      console.error("Load error:", res.status, data);
      // 403 ka matlab mostly galat role (helper se iss page ko open kar rahe ho)
      if (res.status === 403) {
        alert("❌ Access denied: ye page customer ke liye hai.");
      } else {
        alert("❌ Failed to load tasks");
      }
      return;
    }

    const tasks = Array.isArray(data) ? data : [];
    renderTasks(tasks);
  } catch (err) {
    console.error(err);
    alert("❌ Server / Network error while loading tasks");
  }
}

/* ========== RENDER TASK CARDS ========== */
function renderTasks(tasks) {
  taskList.innerHTML = "";

  // top pe chhota toggle dikha dete hai
  const toggleHtml = `
    <div style="margin-bottom:20px; display:flex; gap:10px;">
      <button
        onclick="switchTab('active')"
        style="padding:8px 16px; border-radius:20px; border:none;
               cursor:pointer; font-weight:600;
               background:${currentTab === 'active'
                 ? 'linear-gradient(135deg,#4776E6,#8E54E9)'
                 : '#fff'};
               color:${currentTab === 'active' ? '#fff' : '#2D3748'};
               box-shadow:0 4px 10px rgba(71,118,230,0.2);">
        Active Tasks
      </button>
      <button
        onclick="switchTab('completed')"
        style="padding:8px 16px; border-radius:20px; border:1px solid #CBD5E0;
               cursor:pointer; font-weight:600;
               background:${currentTab === 'completed'
                 ? 'linear-gradient(135deg,#4776E6,#8E54E9)'
                 : '#fff'};
               color:${currentTab === 'completed' ? '#fff' : '#2D3748'};
               box-shadow:0 4px 10px rgba(71,118,230,0.2);">
        Completed Tasks
      </button>
    </div>
  `;

  taskList.insertAdjacentHTML("beforeend", toggleHtml);

  if (tasks.length === 0) {
    const msg =
      currentTab === "completed"
        ? "No completed tasks yet."
        : "No active tasks found.";
    taskList.insertAdjacentHTML("beforeend", `<p>${msg}</p>`);
    return;
  }

  tasks.forEach(task => {
    const card = document.createElement("div");
    card.classList.add("task-detail-card");

    const title = task.title || `Task #${task.task_id}`;
    const urgency = task.urgency || "pending";
    const status = task.status || "open";
    const reward = task.reward_amount ? `₹${task.reward_amount}` : "Not set";
    const created = formatDateTime(task.created_at);

    const mapSrc = task.location
      ? `https://www.google.com/maps?q=${encodeURIComponent(task.location)}&output=embed`
      : "";

    const showReview = status === "completed";

    card.innerHTML = `
      <div class="task-detail-header">
        <h1 class="task-detail-title">${title}</h1>
        <div class="task-status">${status.toUpperCase()}</div>
      </div>
      <div class="task-detail-content">
        <div class="task-detail-section">
          <h3 class="section-title">
            <i class="fas fa-info-circle"></i> Task Details
          </h3>
          <div class="detail-row">
            <div class="detail-label">Urgency</div>
            <div class="detail-value">${urgency}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Reward</div>
            <div class="detail-value">${reward}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Created At</div>
            <div class="detail-value">${created}</div>
          </div>
        </div>

        <div class="section-divider"></div>

        <div class="task-detail-section">
          <h3 class="section-title">
            <i class="fas fa-align-left"></i> Description
          </h3>
          <div class="task-description">
            ${task.description || "No description provided."}
          </div>
        </div>

        <div class="task-detail-section">
          <h3 class="section-title">
            <i class="fas fa-map-marker-alt"></i> Location
          </h3>
          <div class="map-container">
            <iframe
              src="${mapSrc}"
              style="border:0;width:100%;height:100%;"
              allowfullscreen
              loading="lazy">
            </iframe>
          </div>
          <div class="detail-row">
            <div class="detail-label">Address</div>
            <div class="detail-value">${task.location || "Not set"}</div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-primary" onclick="openChat(${task.task_id})">
  <i class="fas fa-comments"></i> Chat with Helper
</button>


          ${status !== 'completed' ? `
            <button class="btn btn-primary" onclick="editTask(${task.task_id})">
              <i class="fas fa-pen"></i> Edit
            </button>
            <button class="btn btn-secondary" onclick="deleteTask(${task.task_id})">
              <i class="fas fa-trash"></i> Delete
            </button>
          ` : ``}
        </div>

        <!-- REVIEW SECTION (sirf completed tasks ke liye) -->
        <div class="review-section" style="display:${showReview ? 'block' : 'none'}; margin-top:40px;">
          <h3 class="section-title">
            <i class="fas fa-star"></i> Rate Your Helper
          </h3>

          <form class="review-form" data-task-id="${task.task_id}">
            <div class="detail-row">
              <div class="detail-label">Rating</div>
              <div class="detail-value">
                <select name="rating" required>
                  <option value="">Select</option>
                  <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                  <option value="4">⭐⭐⭐⭐ Good</option>
                  <option value="3">⭐⭐⭐ Average</option>
                  <option value="2">⭐⭐ Poor</option>
                  <option value="1">⭐ Very Poor</option>
                </select>
              </div>
            </div>

            <div class="detail-row">
              <div class="detail-label">Comment</div>
              <div class="detail-value">
                <textarea name="comment" rows="3"
                  placeholder="Write your experience..." style="width:100%;"></textarea>
              </div>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top:15px;">
              Submit Review
            </button>
          </form>
        </div>
      </div>
    `;

    // review form ka submit handler
    const reviewForm = card.querySelector(".review-form");
    if (reviewForm) {
      reviewForm.addEventListener("submit", e => submitReview(e, task.task_id));
    }

    taskList.appendChild(card);
  });
}

/* ========== TAB SWITCH (ACTIVE <-> COMPLETED) ========== */
function switchTab(tab) {
  if (tab === currentTab) return;
  currentTab = tab;
  loadTasks();
}

/* ========== DELETE TASK (CUSTOMER) ========== */
async function deleteTask(taskId) {
  if (!confirm("❓ Are you sure you want to delete this task?")) return;

  const token = localStorage.getItem("token");
  if (!token) {
    alert("❌ Please login first");
    window.location.href = "index.html";
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/api/tasks/${taskId}`, {
      method: "DELETE",
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      console.error("Delete error:", data);
      alert("❌ Failed to delete task: " + (data.message || ""));
      return;
    }

    alert("✅ Task deleted successfully");
    loadTasks();
  } catch (err) {
    console.error(err);
    alert("❌ Server / Network error while deleting task");
  }
}

    function openChat(taskId) {
  window.location.href = `chat.html?task_id=${taskId}`;
}

/* ========== EDIT TASK (REDIRECT TO d1.html) ========== */
function editTask(taskId) {
  window.location.href = `d1.html?task_id=${taskId}`;
}

/* ========== SUBMIT REVIEW ========== */
async function submitReview(event, taskId) {
  event.preventDefault();

  const form = event.target;
  const rating = form.rating.value;
  const comment = form.comment.value.trim();

  if (!rating) {
    alert("Please select rating");
    return;
  }

  const token = localStorage.getItem("token");
  if (!token) {
    alert("❌ Please login first");
    window.location.href = "index.html";
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/api/tasks/${taskId}/review`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ rating, comment })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      console.error("Review error:", data);
      alert("❌ Failed to submit review: " + (data.message || ""));
      return;
    }

    alert("✅ Review submitted. This task will move to Completed list.");
    // review ke baad active list se remove hoga,
    // isliye completed tab par switch kar dete hain
    currentTab = "completed";
    loadTasks();
  } catch (err) {
    console.error(err);
    alert("❌ Server / Network error while submitting review");
  }
}

/* ========== INIT ========== */
loadTasks();
</script>


</body>
</html>
