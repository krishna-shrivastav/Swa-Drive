<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SwaDrive | Task Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

 <style>
        /* ---------- Same CSS as before ---------- */
        :root {
            --primary: #4776E6;
            --primary-gradient: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%);
            --secondary: #FF8C42;
            --text-dark: #2D3748;
            --text-light: #718096;
            --white: #ffffff;
            --off-white: #F7FAFC;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(71, 118, 230, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: var(--off-white); color: var(--text-dark); line-height: 1.6; }
        h1,h2,h3,h4 { font-family: 'Montserrat', sans-serif; font-weight: 700; line-height: 1.3; }

        /* Navbar & Buttons */
        .navbar { background: var(--white); padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 100; }
        .logo { color: var(--text-dark); font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.5rem; text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .logo span { background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-icon { color: var(--primary); font-size: 1.5rem; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-link { color: var(--text-dark); text-decoration: none; font-weight: 500; transition: color 0.3s; font-size: 0.95rem; }
        .nav-link:hover { color: var(--primary); }
        .nav-link.active { color: var(--primary); font-weight: 600; }
        .nav-link.highlight { background: var(--primary-gradient); color: var(--white); padding: 8px 20px; border-radius: 50px; font-weight: 500; }
        .user-menu { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem; }

        .container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 30px 20px; }
        .breadcrumb { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 0.9rem; }
        .breadcrumb a { color: var(--text-light); text-decoration: none; transition: color 0.3s; }
        .breadcrumb a:hover { color: var(--primary); }
        .breadcrumb .separator { color: var(--text-light); }
        .breadcrumb .current { color: var(--text-dark); font-weight: 500; }

        /* Task Card */
        .task-detail-card { background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 30px; }
        .task-detail-header { padding: 25px 30px; background: var(--primary-gradient); color: var(--white); display: flex; justify-content: space-between; align-items: center; }
        .task-detail-title { font-size: 1.5rem; margin: 0; }
        .task-status { padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background-color: rgba(255,255,255,0.2); }

        .task-detail-content { padding: 30px; }
        .task-detail-section { margin-bottom: 25px; }
        .section-title { font-size: 1.1rem; margin-bottom: 15px; color: var(--text-dark); display: flex; align-items: center; gap: 10px; }
        .section-title i { color: var(--primary); }
        .detail-row { display: flex; margin-bottom: 12px; }
        .detail-label { min-width: 150px; font-weight: 500; color: var(--text-light); }
        .detail-value { color: var(--text-dark); flex: 1; }
        .task-description { background-color: var(--off-white); padding: 20px; border-radius: 8px; margin-bottom: 10px; }
        .map-container { height: 250px; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .special-instructions { background-color: rgba(71, 118, 230, 0.05); padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary); }
        .action-buttons { display: flex; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 50px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary-gradient); color: var(--white); }
        .btn-secondary { background: var(--white); color: var(--text-dark); border: 1px solid rgba(0,0,0,0.1); }
        .task-requester { display: flex; align-items: center; gap: 15px; padding: 20px; background-color: var(--off-white); border-radius: 8px; }
        .requester-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.1rem; }
        .requester-info { flex: 1; }
        .requester-name { font-weight: 600; margin-bottom: 3px; }
        .requester-rating { display: flex; align-items: center; gap: 5px; color: var(--secondary); font-size: 0.9rem; }
        .requester-meta { font-size: 0.85rem; color: var(--text-light); }
        .section-divider { height: 1px; background-color: rgba(0,0,0,0.05); margin: 30px 0; }
        .related-tasks { margin-top: 40px; }
        .related-tasks-title { font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .related-tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .related-task-card { background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 15px; text-decoration: none; color: inherit; }
        .related-task-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(71, 118, 230, 0.15); }
        .related-task-title { font-size: 1rem; margin-bottom: 10px; }
        .related-task-meta { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-light); }
        .task-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>

<body>

<nav class="navbar">
  <a href="Home.html" class="logo"><i class="fas fa-route logo-icon"></i> Swa<span>Drive</span></a>
</nav>

<div class="container">
  <div id="task-list"></div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL = "https://swadrive-backend.onrender.com";
const taskList = document.getElementById("task-list");
const token = localStorage.getItem("token");

/* ================= AUTH GUARD ================= */
if (!token) {
  alert("‚ùå Please login first");
  window.location.href = "index.html";
}

/* ================= UTILS ================= */
function formatDateTime(val){
  if(!val) return "N/A";
  const d = new Date(val);
  return isNaN(d) ? val : d.toLocaleString("en-IN");
}

/* ================= STATE ================= */
let currentTab = "active";

/* ================= LOAD TASKS ================= */
async function loadTasks(){
  try{
    const endpoint = currentTab === "completed"
      ? "/api/my-completed-tasks"
      : "/api/my-tasks";

    const res = await fetch(`${BACKEND_URL}${endpoint}`,{
      headers:{ Authorization:"Bearer "+token }
    });

    const tasks = await res.json();

    if(!res.ok){
      alert("‚ùå Failed to load tasks");
      return;
    }

    renderTasks(Array.isArray(tasks)?tasks:[]);
  }catch(err){
    console.error(err);
    alert("‚ùå Network error");
  }
}

/* ================= RENDER ================= */
function renderTasks(tasks){
  taskList.innerHTML = "";

  const toggle = `
    <div style="margin-bottom:20px;display:flex;gap:10px">
      <button onclick="switchTab('active')">Active</button>
      <button onclick="switchTab('completed')">Completed</button>
    </div>`;
  taskList.insertAdjacentHTML("beforeend",toggle);

  if(tasks.length===0){
    taskList.insertAdjacentHTML("beforeend",
      `<p>${currentTab==="completed"?"No completed tasks":"No active tasks"}</p>`);
    return;
  }

  tasks.forEach(task=>{
    const card=document.createElement("div");
    card.className="task-detail-card";

    const title = task.title || `Task #${task.task_id}`;
    const status = task.status || "open";
    const map = task.location
      ? `<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(task.location)}&output=embed"
         style="border:0;width:100%;height:100%"></iframe>`
      : `<p>No location provided</p>`;

    card.innerHTML=`
      <div class="task-detail-header">
        <h1 class="task-detail-title">${title}</h1>
        <div class="task-status">${status}</div>
      </div>

      <div class="task-detail-content">
        <p><b>Urgency:</b> ${task.urgency||"N/A"}</p>
        <p><b>Reward:</b> ${task.reward_amount?`‚Çπ${task.reward_amount}`:"Not set"}</p>
        <p><b>Created:</b> ${formatDateTime(task.created_at)}</p>

        <h3>Description</h3>
        <p>${task.description||"No description"}</p>

        <h3>Location</h3>
        <div class="map-container">${map}</div>

        <div class="action-buttons">
          <button onclick="history.back()">‚¨Ö Back</button>
          <button onclick="openChat(${task.task_id})">üí¨ Chat</button>
          ${status!=="completed"?`
            <button onclick="editTask(${task.task_id})">‚úè Edit</button>
            <button onclick="deleteTask(${task.task_id})">üóë Delete</button>
          `:""}
        </div>

        ${status==="completed"?reviewBlock(task.task_id):""}
      </div>
    `;

    taskList.appendChild(card);
  });
}

/* ================= REVIEW ================= */
function reviewBlock(id){
  return `
    <form onsubmit="submitReview(event,${id})">
      <select name="rating" required>
        <option value="">Rating</option>
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="3">‚≠ê‚≠ê‚≠ê</option>
        <option value="2">‚≠ê‚≠ê</option>
        <option value="1">‚≠ê</option>
      </select>
      <textarea name="comment" placeholder="Comment"></textarea>
      <button type="submit">Submit Review</button>
    </form>`;
}

/* ================= ACTIONS ================= */
function switchTab(tab){
  currentTab=tab;
  loadTasks();
}

function openChat(id){
  window.location.href=`chat.html?task_id=${id}`;
}

function editTask(id){
  window.location.href=`d1.html?task_id=${id}`;
}

async function deleteTask(id){
  if(!confirm("Delete task?"))return;
  await fetch(`${BACKEND_URL}/api/tasks/${id}`,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token}
  });
  loadTasks();
}

async function submitReview(e,id){
  e.preventDefault();
  const f=e.target;
  await fetch(`${BACKEND_URL}/api/tasks/${id}/review`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({rating:f.rating.value,comment:f.comment.value})
  });
  currentTab="completed";
  loadTasks();
}

/* ================= INIT ================= */
loadTasks();
</script>

</body>
</html>
